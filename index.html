<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Windows Live Hotmail</title>
    <style>
        body { 
            background: #e9f2f8 url('https://wallpaperaccess.com/full/1512140.jpg') no-repeat center top; 
            background-size: cover; font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; 
            display: flex; justify-content: center; align-items: center; min-height: 100vh; 
        }
        .hidden { display: none !important; }

        /* CAJA DE LOGIN */
        .login-box { 
            background: white; padding: 40px; width: 360px; border-radius: 4px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: left;
        }
        .wl-logo { font-size: 26px; color: #444; margin-bottom: 20px; font-weight: 300; }
        .wl-logo span { color: #0078d4; font-weight: bold; }

        .user-pill {
            display: flex; align-items: center; background: #f3f3f3; 
            padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #ddd;
        }
        .user-pill img { width: 40px; height: 40px; border-radius: 3px; margin-right: 10px; }

        input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #999; border-radius: 2px; box-sizing: border-box; }
        .btn { 
            background: linear-gradient(#ffbc40, #ff9d00); color: white; border: 1px solid #d48a00; 
            padding: 8px 25px; cursor: pointer; font-weight: bold; float: right; border-radius: 3px;
        }

        /* INTERFAZ MAIL */
        #mail-ui { width: 100vw; height: 100vh; background: #fff; display: flex; flex-direction: column; }
        .top-bar { background: linear-gradient(#0078d4, #005a9e); color: white; padding: 10px 20px; display: flex; justify-content: space-between; }
        .main-container { display: flex; flex-grow: 1; }
        .sidebar { width: 200px; background: #f4f9fd; border-right: 1px solid #cedee9; padding: 20px; }
        .inbox-view { flex-grow: 1; padding: 20px; }
    </style>
</head>
<body>

    <div id="login-ui" class="login-box">
        <div class="wl-logo">Windows Live <span>Hotmail</span></div>
        
        <div id="remembered-user" class="hidden">
            <div class="user-pill">
                <img id="rem-avatar" src="https://via.placeholder.com/40">
                <div>
                    <b id="rem-name"></b><br>
                    <small id="rem-email" style="color:#666;"></small>
                </div>
            </div>
            <p style="font-size:13px;">Introduce tu contraseña para continuar:</p>
            <input type="password" id="pass-confirm" placeholder="Contraseña">
            <button class="btn" onclick="validarEntrada()">Entrar</button>
            <div style="clear:both; padding-top:15px; font-size:12px;">
                <a href="#" onclick="olvidarCuenta()" style="color:#0066cc; text-decoration:none;">Iniciar sesión con otra cuenta</a>
            </div>
        </div>

        <div id="new-user-ui">
            <p style="font-size:14px; color:#666;">Crea tu cuenta de Intersol.</p>
            <input type="text" id="r-nom" placeholder="Nombre completo">
            <input type="text" id="r-usu" placeholder="nombre-de-usuario">
            <input type="password" id="r-pas" placeholder="Contraseña">
            <button class="btn" onclick="crearCuenta()">Registrarse</button>
        </div>
    </div>

    <div id="mail-ui" class="hidden">
        <div class="top-bar">
            <span><b>Windows Live</b> Hotmail</span>
            <div style="font-size:12px;">
                <span id="mi-id-display"></span> | 
                <span style="cursor:pointer; text-decoration:underline" onclick="cerrarSesionHotmail()">Cerrar sesión en Hotmail</span>
            </div>
        </div>
        <div class="main-container">
            <div class="sidebar">
                <button onclick="location.href='msn.html'" style="width:100%; margin-bottom:10px;">Ir a Messenger</button>
                <div style="font-weight:bold; color:#00457e;">Bandeja de entrada</div>
                <div style="color:#666; font-size:12px; margin-top:100px;">MSN sigue conectado.</div>
            </div>
            <div class="inbox-view">
                <h2 id="welcome-msg">Cargando...</h2>
                <div id="lista-correos">No hay mensajes nuevos.</div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAWMmRpC9chHuBMWbMCRFeEzhQjh1dJ0Uw",
        databaseURL: "https://intersol-ce061-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let session = JSON.parse(localStorage.getItem('intersol_user'));

    // --- LÓGICA DE INICIO ---
    function init() {
        if (sessionStorage.getItem('hotmail_active') === 'true' && session) {
            mostrarHotmail();
        } else if (session) {
            // Usuario existe en el navegador pero no en la pestaña actual de mail
            document.getElementById('new-user-ui').classList.add('hidden');
            document.getElementById('remembered-user').classList.remove('hidden');
            document.getElementById('rem-name').innerText = session.nombre;
            document.getElementById('rem-email').innerText = session.email;
        }
    }

    window.validarEntrada = async function() {
        const pass = document.getElementById('pass-confirm').value;
        const path = session.email.replace(/\./g, '_');
        
        const dbRef = ref(db);
        const snapshot = await get(child(dbRef, `intersol/usuarios/${path}`));
        
        if (snapshot.exists() && snapshot.val().password === pass) {
            sessionStorage.setItem('hotmail_active', 'true');
            mostrarHotmail();
        } else {
            alert("Contraseña incorrecta.");
        }
    };

    window.crearCuenta = async function() {
        const nom = document.getElementById('r-nom').value;
        const usu = document.getElementById('r-usu').value.trim().toLowerCase() + "@intersol.com";
        const pas = document.getElementById('r-pas').value;

        if(!nom || !pas) return alert("Completa los datos");

        const path = usu.replace(/\./g, '_');
        const userObj = { nombre: nom, email: usu, password: pas };

        await set(ref(db, 'intersol/usuarios/' + path), userObj);
        localStorage.setItem('intersol_user', JSON.stringify(userObj));
        sessionStorage.setItem('hotmail_active', 'true');
        location.reload();
    };

    function mostrarHotmail() {
        document.getElementById('login-ui').classList.add('hidden');
        document.getElementById('mail-ui').classList.remove('hidden');
        document.getElementById('mi-id-display').innerText = session.email;
        document.getElementById('welcome-msg').innerText = "Hola, " + session.nombre;
        document.body.style.background = "#fff";
    }

    window.cerrarSesionHotmail = () => {
        // Solo cerramos la "vista" de Hotmail, no borramos localStorage (MSN sigue vivo)
        sessionStorage.removeItem('hotmail_active');
        location.reload();
    };

    window.olvidarCuenta = () => {
        if(confirm("¿Seguro? Esto también cerrará tu sesión en el Messenger.")){
            localStorage.removeItem('intersol_user');
            location.reload();
        }
    };

    init();
</script>
</body>
</html>
